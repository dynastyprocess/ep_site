---
title: "DP Expected Points"
description: |
  Expected Points modelling - last updated on `r as.character(Sys.Date())`.
site: distill::distill_website
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(reactable)
library(crosstalk)
library(arrow)
library(dplyr)
library(janitor)
library(ffpros)
library(ffscrapr)
library(tidyr)

fp <- fp_rankings(page = "ros-ppr-overall", sport = "nfl", year = 2021) %>%
  left_join(select(dp_playerids(), fantasypros_id, gsis_id), by = "fantasypros_id") %>% 
  transmute(gsis_id, "ROS ECR" = round(ecr,1))

ep <- arrow::read_parquet("data/expected_points_2021.pdata") %>%
  transmute(
    player_name = full_name,
    # season,
    weeks = week,
    pos = position,
    team = posteam,
    total_fantasy_points_exp,
    total_fantasy_points,
    total_fantasy_points_diff,
    rec_fantasy_points_exp,
    rec_fantasy_points,
    rec_fantasy_points_diff,
    rush_fantasy_points_exp,
    rush_fantasy_points,
    rush_fantasy_points_diff,
    pass_fantasy_points_exp,
    pass_fantasy_points,
    pass_fantasy_points_diff,
    gsis_id = player_id
  ) %>%
  filter(pos %in% c("QB", "RB", "WR", "TE")) %>%
  # group_by(player_name, gsis_id, pos, team) %>%
  # summarise(
  #   across(.cols = where(is.numeric),
  #          .fns = ~ mean(.x, na.rm = TRUE) %>% round(1)),
  #       games = n()
  # ) %>%
  # ungroup() %>%
  janitor::clean_names("title") %>%
  rename_with(~ stringr::str_replace(.x, "Fantasy Points", "FP")) %>%
  left_join(fp, by = c("Gsis Id" = "gsis_id")) %>% 
  select(-"Gsis Id") %>%
  mutate("ROS ECR" = replace_na(`ROS ECR`, max(`ROS ECR`, na.rm = TRUE))) %>% 
  relocate("ROS ECR", .after = "Team")

crosstalk_ep <- crosstalk::SharedData$new(ep)
```



```{r layout = "l-page", fig.width = 16, fig.height = 16}

htmltools::tags$h3("Season Average Expected Points")

table_ep <- crosstalk_ep %>%
  reactable(
    searchable = TRUE,
    striped = TRUE,
    highlight = TRUE,
    resizable = TRUE,
    compact = TRUE,
    groupBy = "Player Name",
    columns = list(
      `Pos` = colDef(minWidth = 50, aggregate = "unique"),
      `Team` = colDef(minWidth = 50, aggregate = "unique"),
      `Weeks` = colDef(minWidth = 50, aggregate = "count", format = colFormat(digits = 0)),
      `Games` = colDef(name = "GP", format = colFormat(digits = 0)),
      `Player Name` = colDef(minWidth = 120)
    ),
    defaultColDef = colDef(minWidth = 70,
                           format = colFormat(digits = 1),
                           aggregate = "mean"),
    fullWidth = TRUE,
    defaultSortOrder = "desc",
    defaultSorted = c("Total FP Exp"),
    defaultPageSize = 25,
    pageSizeOptions = c(25,50,100,500),
    showPageSizeOptions = TRUE
  )

bscols(
  widths = rep_len(3, 4),
  filter_checkbox("pos", "Position", crosstalk_ep, ~`Pos`, inline = TRUE),
  filter_select("team", "Team", crosstalk_ep, ~`Team`),
  filter_select("weeks", "Weeks", crosstalk_ep, ~`Weeks`),
  filter_slider("Total FP Exp", "EP", crosstalk_ep, ~`Total FP Exp`)
  # filter_slider("season", "Season", crosstalk_ep, ~`Season`, ticks = FALSE, width = "100%", sep = NULL, step = 1),
  # filter_slider("gp", "Games Played", crosstalk_ep, ~`Games`, ticks = FALSE, width = "100%")
)
table_ep
```
